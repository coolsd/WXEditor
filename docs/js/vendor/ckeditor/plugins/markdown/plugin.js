/*
 *  The "markdown" plugin. It's indented to enhance the
 *  "sourcearea" editing mode, convert to markdown mode and highlight syntax.
 * Licensed under the MIT license
 * CodeMirror Plugin: http://codemirror.net/ (MIT License)
 * Markdown Parser:
 * HTML to Markdown Parser: 
 */

!function(){CKEDITOR.plugins.add("markdown",{icons:"markdown",hidpi:!0,init:function(t){function n(e,t){window["codemirror_"+e.id]=CodeMirror.fromTextArea(t.$,e.config.markdown),window["codemirror_"+e.id].setSize(null,"100%")}function o(){var e=r&&this.equals(CKEDITOR.document.getActive());this.hide(),this.setStyle("height",this.getParent().$.clientHeight+"px"),this.setStyle("width",this.getParent().$.clientWidth+"px"),this.show(),e&&this.focus()}if(t.elementMode!=CKEDITOR.ELEMENT_MODE_INLINE){var a=CKEDITOR.plugins.markdown,i=this.path,d={mode:"gfm",lineNumbers:!0,theme:"default"};t.config.markdown=CKEDITOR.tools.extend(d,t.config.markdown||{},!0),t.addMode("markdown",function(a){var d=t.ui.space("contents"),r=d.getDocument().createElement("textarea"),s=t.config.markdown;r.setStyles(CKEDITOR.tools.extend({width:CKEDITOR.env.ie7Compat?"99%":"100%",height:"100%",resize:"none",outline:"none","text-align":"left"},CKEDITOR.tools.cssVendorPrefix("tab-size",t.config.sourceAreaTabSize||4))),r.setAttribute("dir","ltr"),r.addClass("cke_source cke_reset cke_enable_context_menu"),t.ui.space("contents").append(r);var m=t.editable(new e(t,r)),c=t.getData(1);"undefined"==typeof toMarkdown?CKEDITOR.scriptLoader.load(i+"js/to-markdown.js",function(){m.setData(toMarkdown(c))}):m.setData(toMarkdown(c)),"undefined"==typeof CodeMirror||"undefined"==typeof CodeMirror.modes.gfm?(CKEDITOR.document.appendStyleSheet(i+"css/codemirror.min.css"),s.theme.length&&"default"!=s.theme&&CKEDITOR.document.appendStyleSheet(i+"theme/"+s.theme+".css"),CKEDITOR.scriptLoader.load(i+"js/codemirror-gfm-min.js",function(){n(t,m)})):n(t,m),"undefined"==typeof marked&&CKEDITOR.scriptLoader.load(i+"js/marked.js"),CKEDITOR.env.ie&&(m.attachListener(t,"resize",o,m),m.attachListener(CKEDITOR.document.getWindow(),"resize",o,m),CKEDITOR.tools.setTimeout(o,0,m)),t.fire("ariaWidget",this),t.commands.maximize.modes.markdown=1,a()}),t.addCommand("markdown",a.commands.markdown),t.ui.addButton&&t.ui.addButton("Markdown",{label:"Markdown",command:"markdown"}),CKEDITOR.document.appendStyleText(".cke_button__markdown_label {display: inline;}"),t.on("mode",function(){t.getCommand("markdown").setState("markdown"==t.mode?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF)});var r=CKEDITOR.env.ie&&9==CKEDITOR.env.version}}});var e=CKEDITOR.tools.createClass({base:CKEDITOR.editable,proto:{setData:function(e){this.setValue(e),this.status="ready",this.editor.fire("dataReady")},getData:function(){return this.getValue()},insertHtml:function(){},insertElement:function(){},insertText:function(){},setReadOnly:function(e){this[(e?"set":"remove")+"Attribute"]("readOnly","readonly")},detach:function(){var t=this.editor;window["codemirror_"+t.id].toTextArea(),window["codemirror_"+t.id]=null;var n=t.getData();t.setData(marked(n,{langPrefix:"language-"})),e.baseProto.detach.call(this),this.clearCustomData(),this.remove()}}})}(),CKEDITOR.plugins.markdown={commands:{markdown:{modes:{wysiwyg:1,markdown:1},editorFocus:!1,readOnly:1,exec:function(e){"wysiwyg"==e.mode&&e.fire("saveSnapshot"),e.getCommand("markdown").setState(CKEDITOR.TRISTATE_DISABLED),e.setMode("markdown"==e.mode?"wysiwyg":"markdown")},canUndo:!1}}};