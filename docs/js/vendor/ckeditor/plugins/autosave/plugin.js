/**
 * @license Copyright (c) CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.html or http://ckeditor.com/license
 */

!function(){function e(e){var t=null!=e.config.autosave_SaveKey?e.config.autosave_SaveKey:"autosave_"+window.location+"_"+e.id,o=null!=e.config.autosave_NotOlderThen?e.config.autosave_NotOlderThen:1440,l=null!=e.config.autosave_saveOnDestroy?e.config.autosave_saveOnDestroy:!1,u=null!=e.config.autosave_saveDetectionSelectors?e.config.autosave_saveDetectionSelectors:"a[href^='javascript:__doPostBack'][id*='Save'],a[id*='Cancel']";CKEDITOR.scriptLoader.load(CKEDITOR.getUrl(CKEDITOR.plugins.getPath("autosave")+"js/extensions.min.js"),function(){a(e,t),n(e,t,o)}),jQuery(u).click(function(){s(t)}),e.on("change",d),e.on("destroy",function(){l&&i(t,e)})}function t(){if("undefined"==typeof Storage)return!1;try{return localStorage.getItem("___test_key"),!0}catch(e){return!1}}function a(e,t){CKEDITOR.dialog.add("autosaveDialog",function(){return{title:e.lang.autosave.title,minHeight:155,height:300,width:750,onShow:function(){l(this,e,t)},onOk:function(){if(localStorage.getItem(t)){var a=o(t);e.loadSnapshot(a.data),s(t)}},onCancel:function(){s(t)},contents:[{label:"",id:"general",elements:[{type:"radio",id:"diffType",label:e.lang.autosave.diffType,items:[[e.lang.autosave.sideBySide,"sideBySide"],[e.lang.autosave.inline,"inline"]],"default":"sideBySide",onClick:function(){l(this._.dialog,e,t)}},{type:"html",id:"diffContent",html:""}]}],buttons:[{id:"ok",type:"button",label:e.lang.autosave.ok,"class":"cke_dialog_ui_button_ok cke_dialog_autosave_ok",onClick:function(e){var t=e.data.dialog;t.fire("ok",{hide:!0}).hide!==!1&&t.hide()}},{id:"cancel",type:"button",label:e.lang.autosave.no,"class":"cke_dialog_ui_button_cancel",onClick:function(e){var t=e.data.dialog;t.fire("cancel",{hide:!0}).hide!==!1&&t.hide()}}]}})}function n(e,t,a){if(localStorage.getItem(t)){var n=o(t),i=n.data,l=n.saveTime,u=e.getSnapshot();if(u==i)return void localStorage.removeItem(t);if(moment(new Date).diff(new Date(l),"minutes")>a)return void s(t);var c=e.lang.autosave.loadSavedContent.replace("{0}",moment(l).locale(e.config.language).format(e.lang.autosave.dateFormat));confirm(c)?e.openDialog("autosaveDialog"):s(t)}}function o(e){var t=LZString.decompressFromUTF16(localStorage.getItem(e));return JSON.parse(t)}function i(e,t){var a=LZString.compressToUTF16(JSON.stringify({data:t.getSnapshot(),saveTime:new Date}));localStorage.setItem(e,a);var n=new CKEDITOR.plugins.notification(t,{message:t.lang.autosave.autoSaveMessage,type:"success"});n.show()}function s(e){u&&clearTimeout(u),localStorage.removeItem(e)}function l(e,t,a){var n=o(a),i=difflib.stringAsLines(t.getSnapshot()),s=difflib.stringAsLines(n.data),l=new difflib.SequenceMatcher(i,s),u=l.get_opcodes();e.getContentElement("general","diffContent").getElement().setHtml('<div class="diffContent">'+diffview.buildView({baseTextLines:i,newTextLines:s,opcodes:u,baseTextName:t.lang.autosave.loadedContent,newTextName:t.lang.autosave.autoSavedContent+moment(n.saveTime).locale(t.config.language).format(t.lang.autosave.dateFormat)+"'",contextSize:3,viewType:"inline"==e.getContentElement("general","diffType").getValue()?1:0}).outerHTML+"</div>")}if(!t())return void CKEDITOR.plugins.add("autosave",{});CKEDITOR.plugins.add("autosave",{lang:"ca,cs,de,en,es,fr,ja,pl,pt-br,sv,zh,zh-cn",requires:"notification",version:.13,init:function(t){CKEDITOR.document.appendStyleSheet(CKEDITOR.getUrl(CKEDITOR.plugins.getPath("autosave")+"css/autosave.min.css")),t.on("instanceReady",function(){"undefined"==typeof jQuery?CKEDITOR.scriptLoader.load("//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js",function(){jQuery.noConflict(),e(t)}):CKEDITOR.scriptLoader.load(CKEDITOR.getUrl(CKEDITOR.plugins.getPath("autosave")+"js/extensions.min.js"),function(){e(t)})},t,null,100)}});var u=0,c=!1,d=function(e){if(u);else{var t=null!=CKEDITOR.config.autosave_delay?CKEDITOR.config.autosave_delay:10;u=setTimeout(r,1e3*t,e)}},r=function(e){if(c)d(e);else if(e.editor.checkDirty()||e.editor.plugins.bbcode){c=!0;var t=e.editor,a=null!=t.config.autosave_SaveKey?t.config.autosave_SaveKey:"autosave_"+window.location+"_"+t.id;i(a,t),u=0,c=!1}}}();